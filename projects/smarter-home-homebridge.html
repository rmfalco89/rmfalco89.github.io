<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>smarterHome-homebridge - Riccardo Marino</title>
    <link rel="stylesheet" href="../css/project.css">
</head>
<body>
    <nav class="back-nav">
        <a href="../index.html" class="back-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Back to Portfolio
        </a>
    </nav>
    
    <article class="project-detail">
        <header class="project-header">
            <h1>smarterHome-homebridge</h1>
            <p class="subtitle">Custom Homebridge Plugin for Tuya Smart Home Integration</p>
            <div class="project-meta">
                <a href="https://github.com/rmfalco89/smarterHome-homebridge" target="_blank" class="github-link">
                    View on GitHub
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                </a>
                <div class="tech-stack">
                    <span class="tech-tag">TypeScript</span>
                    <span class="tech-tag">Node.js</span>
                    <span class="tech-tag">Homebridge</span>
                    <span class="tech-tag">Tuya Cloud API</span>
                </div>
            </div>
        </header>
        
        <section class="content-section">
            <h2>Project Overview</h2>
            <p>Part of the larger <strong>SmarterHome</strong> ecosystem, this repository contains a customized fork of the popular <code>homebridge-tuya-web</code> plugin. The project enables seamless integration between Apple HomeKit and Tuya-based smart home devices (lights, switches, thermostats, fans, etc.) through Homebridge, allowing iOS users to control their Tuya devices using Siri, the Home app, and HomeKit automations.</p>
            <p>Rather than starting from scratch, this project strategically forks and fixes an existing open-source solution, demonstrating pragmatic problem-solving: identify what works, fix what doesn't, and maintain compatibility with upstream improvements.</p>
        </section>
        
        <section class="content-section">
            <h2>The Problem</h2>
            <p>Tuya manufactures white-label smart home devices sold under hundreds of brands (Smart Life, Jinvoo Smart, etc.). While these devices work well with their native mobile apps, integrating them into Apple's HomeKit ecosystem requires a bridge solution like Homebridge.</p>
            <p>The original <code>homebridge-tuya-web</code> plugin by milo526 provided this bridge functionality but had <strong>TypeScript compilation errors</strong> that prevented it from building correctly in modern Node.js/TypeScript environments. These issues blocked deployment and updates.</p>
        </section>
        
        <section class="content-section">
            <h2>The Solution</h2>
            <p>This fork addresses the compilation issues with targeted fixes while maintaining full compatibility with the upstream plugin's functionality.</p>
        </section>
        
        <section class="content-section">
            <h2>Key Fixes Implemented</h2>
            
            <div class="feature-card">
                <h3>1. Service UUID Generation Fix</h3>
                <p><strong>Problem:</strong> When creating new HomeKit services, the plugin wasn't properly generating unique UUIDs, causing potential conflicts and crashes.</p>
                <p><strong>Fix:</strong></p>
                <pre><code>// Before: Missing UUID parameter
this.service = homebridgeAccessory.addService(
  this.serviceType,
  this.deviceConfig.name
);

// After: Properly generates UUID
this.service = homebridgeAccessory.addService(
  this.serviceType,
  this.deviceConfig.name,
  this.platform.generateUUID(this.service)
);</code></pre>
                <p>This ensures each HomeKit accessory has a unique identifier, preventing collisions when multiple devices are registered.</p>
            </div>
            
            <div class="feature-card">
                <h3>2. Generic Type Constraint Enhancement</h3>
                <p><strong>Problem:</strong> TypeScript couldn't properly infer types when setting device state, leading to compilation errors.</p>
                <p><strong>Fix:</strong></p>
                <pre><code>// Before: Loose generic constraint
public async setDeviceState&lt;Method extends TuyaApiMethod, T&gt;(
  method: Method,
  payload: TuyaApiPayload&lt;Method&gt;,
  cache: T
)

// After: Properly constrained generic
public async setDeviceState&lt;Method extends TuyaApiMethod, T extends DeviceState&gt;(
  method: Method,
  payload: TuyaApiPayload&lt;Method&gt;,
  cache: T
)</code></pre>
                <p>The added <code>T extends DeviceState</code> constraint provides proper type safety and enables TypeScript to validate state updates at compile time.</p>
            </div>
            
            <div class="feature-card">
                <h3>3. Template Literal Fixes</h3>
                <p><strong>Problem:</strong> Error messages used incorrect string concatenation syntax instead of template literals.</p>
                <p><strong>Fix:</strong></p>
                <pre><code>// Before: Broken template syntax
this.log?.warn("Cannot acquire token, waiting ${this.authTokenWaitTime} seconds.");

// After: Proper template literals
this.log?.warn(`Cannot acquire token, waiting ${this.authTokenWaitTime} seconds.`);</code></pre>
                <p>This ensures error messages display correctly with interpolated values, improving debugging capabilities.</p>
            </div>
        </section>
        
        <section class="content-section">
            <h2>Architecture</h2>
            <p>The plugin follows Homebridge's standard platform plugin architecture:</p>
            <div class="architecture-diagram">
                <pre>
smarterHome-homebridge/
├── homebridge-tuya-web/          # Forked and modified plugin
│   ├── src/
│   │   ├── accessories/          # Device type implementations
│   │   │   ├── BaseAccessory.ts  # Abstract base class (FIXED)
│   │   │   ├── ClimateAccessory.ts
│   │   │   ├── CoverAccessory.ts
│   │   │   ├── FanAccessory.ts
│   │   │   ├── LightAccessory.ts
│   │   │   └── ...
│   │   ├── api/
│   │   │   └── service.ts        # Tuya API client (FIXED)
│   │   ├── helpers/              # Utilities & caching
│   │   ├── platform.ts           # Main platform entry point
│   │   └── index.ts
│   ├── config.schema.json        # Homebridge UI config schema
│   └── package.json              # Published as @rmfalco89/homebridge-tuya-web
                </pre>
            </div>
            
            <h3>Data Flow</h3>
            <ol>
                <li><strong>Discovery:</strong> Plugin authenticates with Tuya Cloud API and fetches device list</li>
                <li><strong>Device Registration:</strong> Each Tuya device is mapped to a HomeKit accessory type</li>
                <li><strong>State Caching:</strong> Device states are cached in memory for responsive HomeKit queries</li>
                <li><strong>Control:</strong> HomeKit commands are translated to Tuya API calls</li>
                <li><strong>Updates:</strong> Optional polling keeps HomeKit in sync with external changes</li>
            </ol>
        </section>
        
        <section class="content-section">
            <h2>Supported Device Types</h2>
            <p>The plugin supports a wide range of Tuya devices:</p>
            <ul>
                <li><strong>Climate/Thermostats:</strong> Read and set temperature, control modes</li>
                <li><strong>Covers:</strong> Window blinds, shades, curtains (with optional garage door mode)</li>
                <li><strong>Fans:</strong> On/off control, speed adjustment</li>
                <li><strong>Lights/Dimmers:</strong> On/off, brightness control</li>
                <li><strong>Switches/Outlets:</strong> Simple on/off control</li>
                <li><strong>Scenes:</strong> Trigger pre-configured Tuya scenes from HomeKit</li>
            </ul>
        </section>
        
        <section class="content-section">
            <h2>Configuration</h2>
            <p>Configured through Homebridge's <code>config.json</code> or the web UI:</p>
            <pre><code>{
  "platform": "TuyaWebPlatform",
  "name": "TuyaWebPlatform",
  "options": {
    "username": "user@example.com",
    "password": "password",
    "countryCode": "1",
    "platform": "tuya",
    "pollingInterval": 1800
  },
  "defaults": [
    {
      "id": "device-name-or-id",
      "device_type": "dimmer"
    }
  ],
  "hiddenAccessories": ["unwanted-device"],
  "scenes": true,
  "scenesWhitelist": ["Morning", "Evening"]
}</code></pre>
        </section>
        
        <section class="content-section">
            <h2>Technical Highlights</h2>
            
            <ul class="highlights-list">
                <li><strong>Smart Forking Strategy:</strong> Leverages the mature <code>homebridge-tuya-web</code> codebase, maintaining compatibility with upstream improvements while only modifying what's necessary to fix compilation issues</li>
                <li><strong>Type Safety Improvements:</strong> The TypeScript fixes add real type safety—preventing runtime errors from incorrect state updates, catching device configuration errors at build time, and improving IDE autocomplete</li>
                <li><strong>Integration with SmarterHome Ecosystem:</strong> Works alongside <code>smarterHome-webserver</code>, <code>smarterHome-arduino</code>, and <code>smartHomebridge</code> to create a hybrid smart home system combining commercial Tuya devices with custom-built hardware</li>
                <li><strong>Published to npm:</strong> Available as <code>@rmfalco89/homebridge-tuya-web</code> for easy installation</li>
            </ul>
        </section>
        
        <section class="content-section">
            <h2>Real-World Use</h2>
            <p>In practice, this plugin enables:</p>
            <ul>
                <li><strong>Voice Control:</strong> "Hey Siri, turn off the living room lights"</li>
                <li><strong>HomeKit Automations:</strong> "When I arrive home, turn on the porch light"</li>
                <li><strong>Remote Access:</strong> Control devices from anywhere using Home app</li>
                <li><strong>Integration:</strong> Combine Tuya devices with HomeKit-native accessories in scenes</li>
            </ul>
            <p>All while maintaining the reliability and feature set of the original plugin.</p>
        </section>
        
        <section class="content-section">
            <h2>Deployment</h2>
            <p>Published to npm registry:</p>
            <pre><code>npm install -g @rmfalco89/homebridge-tuya-web</code></pre>
            <p>Or installed directly via Homebridge Config UI X plugin search.</p>
        </section>
        
        <section class="content-section">
            <h2>Lessons Learned</h2>
            <ul>
                <li><strong>Forking is a valid strategy</strong> when upstream projects are unmaintained but functional</li>
                <li><strong>Minimal fixes are best</strong> — change only what's necessary to reduce merge conflicts</li>
                <li><strong>Type safety matters</strong> — proper TypeScript constraints catch bugs early</li>
                <li><strong>Smart home integration is complex</strong> — cloud APIs, device diversity, HomeKit quirks all add layers</li>
            </ul>
        </section>
        
        <section class="content-section">
            <h2>Why It's Interesting</h2>
            <p><code>smarterHome-homebridge</code> exemplifies <strong>pragmatic engineering</strong>: identify a working solution, fix what's broken, maintain what works. By carefully fixing compilation errors in an established plugin rather than reinventing the wheel, this project delivers reliable HomeKit integration for Tuya devices with minimal maintenance overhead.</p>
            <p>It's a testament to the power of open-source ecosystems — sometimes the best code you write is the code you <em>don't</em> write, because someone else already did the heavy lifting.</p>
        </section>
    </article>
    
    <footer class="project-footer">
        <a href="../index.html" class="footer-link">← Back to Portfolio</a>
    </footer>
</body>
</html>
