<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sump Pump Manager | Riccardo Marino</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/project-detail.css">
</head>
<body>
    <div class="detail-container">
        <a href="../index.html" class="back-link">
            <span>←</span>
            <span>Back to Portfolio</span>
        </a>
        
        <header class="project-header">
            <h1>Sump Pump Manager (SPM)</h1>
            
            <div class="project-meta">
                <div class="meta-item">
                    <span class="meta-label">Repository</span>
                    <span class="meta-value">
                        <a href="https://github.com/rmfalco89/sump_pump-control" target="_blank">
                            rmfalco89/sump_pump-control ↗
                        </a>
                    </span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Platform</span>
                    <span class="meta-value">ESP32/ESP8266</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Language</span>
                    <span class="meta-value">C++</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Framework</span>
                    <span class="meta-value">Arduino/PlatformIO</span>
                </div>
            </div>
        </header>

        <article>
            <h2>The Problem</h2>
            <p>After a power outage in early 2024, a basement flooded and the existing high-powered sump pump nearly caused a disaster—its powerful discharge overwhelmed the sewage line, causing water to back up through the kitchen sink. The homeowner wanted to add a second, gentler pump that would discharge into an irrigation tank instead, but faced several constraints:</p>
            
            <ul>
                <li><strong>Physical space:</strong> Only one bucket/pit in the basement floor—no room for a second float switch</li>
                <li><strong>Pump limitation:</strong> The new pump isn't self-priming, so it can't run dry</li>
                <li><strong>Coordination complexity:</strong> Two pumps with different discharge points need intelligent orchestration</li>
                <li><strong>Reliability:</strong> Must handle edge cases like flood scenarios, sensor failures, and relay overheating</li>
            </ul>
            
            <p>The solution needed to be robust, configurable, and capable of operating autonomously while integrating with Home Assistant for monitoring and alerts.</p>

            <h2>The Solution</h2>
            <p>SPM is an embedded IoT controller that coordinates two sump pumps using multiple sensors and configurable operating modes. The system runs on an ESP32/ESP8266 microcontroller and exposes a web interface for configuration and monitoring.</p>

            <h3>Key Features</h3>
            
            <p><strong>Multi-Sensor Water Level Detection:</strong></p>
            <ul>
                <li>5 float switches at different heights (bottom, middle-bottom, middle-middle, middle-top, top)</li>
                <li>TF-Luna LIDAR sensor for precise distance measurement</li>
                <li>Configurable sensor selection for different middle-level triggers</li>
            </ul>

            <p><strong>Flexible Operating Modes:</strong></p>
            <ul>
                <li><code>AUTO</code>: Float switch-driven activation</li>
                <li><code>TIMED</code>: Run/rest cycles (e.g., 2 min on, 3 min off)</li>
                <li><code>AUTOTIMED</code>: Hybrid mode combining both</li>
                <li><code>TIMEBASED</code>: Delayed activation after sustained water level</li>
                <li><code>INACTIVE</code>: Manual override to disable</li>
            </ul>

            <p><strong>Safety & Monitoring:</strong></p>
            <ul>
                <li>Temperature monitoring on solid-state relay (SSR) to prevent overheating</li>
                <li>Flood mode detection when bucket doesn't empty within expected time</li>
                <li>Home Assistant integration for alerts and health checks</li>
                <li>Adaptive timing for time-based mode (auto-adjusts wait period based on pump performance)</li>
            </ul>

            <h2>Interesting Code Patterns</h2>

            <h3>1. State-Based Pump Operation with Adaptive Timing</h3>
            <p>The system implements a sophisticated state machine for pump control that adapts to real-world conditions:</p>

<pre><code>// Adaptive wait time for time-based mode
if (newPump->isInTimeBasedMode() && 
    waterLevelSensorBottom->submerged && 
    millis() - waterLevelSensorBottom->lastChangedStatusMillis > waitBeforeActivatingNewPumpMillis && 
    !newPump->getIsAutoPumping())
{
    newPump->setAutoPumping(true);
}

// Self-adjusting wait period based on performance
if (newPump->getAutoPumpingOnToOffTimeMillis() < (systemConfiguration->minRunTimeNewPump - 1000)
    && waitBeforeActivatingNewPumpMillis < 3 * 60 * 60 * 1000)
{
    waitBeforeActivatingNewPumpMillis += 60 * 1000; // Pump ran too short - wait longer next time
}</code></pre>

            <p>This adaptive behavior prevents the pump from cycling too frequently when inflow is low, extending pump life.</p>

            <h3>2. Dual-Mode Relay Abstraction</h3>
            <p>The <code>Relay</code> struct elegantly handles both standard mechanical relays and solid-state relays (SSR) with different triggering logic:</p>

<pre><code>struct Relay {
    RelayType type;
    uint8_t pin;
    bool active_high;
    RelayOperation currentStatus;
    uint64_t lastSwitchedMillis;
    uint64_t counterON;
    
    void power(RelayOperation operation) {
        if (operation == currentStatus)
            return;
        
        bool on = operation == ON ? true : false;
        byte switchValue = active_high == on ? HIGH : LOW;
        
        digitalWrite(pin, switchValue);
        lastSwitchedMillis = millis();
        currentStatus = operation;
        
        if (on)
            counterON++;
    }
};</code></pre>

            <p>The <code>active_high</code> flag allows the same code to control both active-high and active-low relay modules, while the counter tracks usage statistics.</p>

            <h3>3. Emergency Flood Mode with Configuration Swapping</h3>
            <p>When the system detects a flooding scenario, it dynamically reconfigures both pumps:</p>

<pre><code>if (newPump->isTakingTooLongToEmptyBucket() || oldPump->isTakingTooLongToEmptyBucket()) {
    LOG_PRINTLN("!!! FLOOD MODE !!!");
    floodMode = true;
    invokeHassFloodAlert();
    
    // Swap to emergency configuration
    SystemConfiguration basementFloodedConfiguration = 
        SystemConfiguration::getBasementFloodedConfiguration();
    configurePumps(&basementFloodedConfiguration);
}</code></pre>

            <p>This hot-swapping of configurations without restart allows the system to respond immediately to critical situations.</p>

            <h2>Technical Highlights</h2>
            <ul>
                <li><strong>Real-time responsiveness:</strong> 50ms main loop with non-blocking async web server</li>
                <li><strong>Persistent configuration:</strong> EEPROM storage with structure packing</li>
                <li><strong>Cross-platform:</strong> Supports both ESP32 and ESP8266 via PlatformIO build targets</li>
                <li><strong>Diagnostics:</strong> Comprehensive status reporting via serial console and web interface</li>
                <li><strong>Safety-first:</strong> Multiple redundant sensors and fail-safe modes</li>
            </ul>

            <h2>Why It's Interesting</h2>
            <p>This project exemplifies practical embedded systems development:</p>
            
            <ul>
                <li><strong>Real-world problem solving:</strong> Addresses an actual home flooding risk with multiple constraints</li>
                <li><strong>Sensor fusion:</strong> Combines float switches and LIDAR for robust water level detection</li>
                <li><strong>Adaptive algorithms:</strong> Self-tuning timers based on observed performance</li>
                <li><strong>Fail-safe design:</strong> Multiple layers of safety checks and emergency modes</li>
                <li><strong>IoT integration:</strong> Home Assistant webhooks for remote monitoring and alerts</li>
                <li><strong>Maintainability:</strong> Clean abstractions (Relay, SumpPump) with comprehensive logging</li>
            </ul>
            
            <p>The code demonstrates how embedded C++ can be organized for clarity without sacrificing performance—a balance often lost in Arduino projects.</p>
        </article>
        
        <footer>
            <div class="social-links">
                <a href="https://www.linkedin.com/in/rimarino/" target="_blank" title="LinkedIn">
                    <svg xmlns="http://www.w3.org/2000/svg" role="img" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
                        <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                        <rect x="2" y="9" width="4" height="12"></rect>
                        <circle cx="4" cy="4" r="2"></circle>
                    </svg>
                </a>
                <a href="mailto:rmfalco.89@gmail.com" title="Email">
                    <svg xmlns="http://www.w3.org/2000/svg" role="img" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                </a>
            </div>
            <p>Built by Riccardo Marino</p>
        </footer>
    </div>
</body>
</html>
